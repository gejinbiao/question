 # 集群模式（主从模式、哨兵模式、cluster 集群模式）

# 1. Redis 集群模式分类
Redis 集群模式有三种：

- 主从模式
- 哨兵模式
- Cluster 集群模式

## 1.1 主从模式
为了 Redis 服务避免单点故障，通常的做法是将 Redis 数据复制多个副本以部署在不同的服务器上。这样即使有一台服务器出现故障，其他服务器依然可以继续提供服务。为此，Redis 提供了复制（ replication ）功能，可以实现当一台数据库中的数据更新后，自动将更新的数据同步到其他数据库上。

Redis 服务器分为两类：一类是主数据库（Master），另一类是从数据库（Slave）。

主数据库可以进行读写操作，当写操作导致数据变化时会自动将数据同步给从数据库。

从数据库一般是只读的，并接受主数据库同步过来的数据。一个主数据库可以拥有多个从数据库，而一个从数据库只能拥有一个主数据库。

如图所示：
![NWBm1H.png](https://s1.ax1x.com/2020/06/29/NWBm1H.png)

**优点：**

1. 一个主，可以有多个从，并以非阻塞的方式完成数据同步；
1. 从服务器提供读服务，分散主服务的压力，实现读写分离；
1. 从服务器之前可以彼此连接和同步请求，减少主服务同步压力；

**缺点：**

1. 不具备容错和恢复功能，主服务存在单点风险；
1. Redis 的主从复制采用全量复制，需要服务器有足够的空余内存；
1. 主从模式较难支持在线扩容；


## 1.2 哨兵模式

Redis 提供的 sentinel（哨兵）机制，通过 sentinel 模式启动 redis 后，自动监控 Master/Slave 的运行状态，基本原理是：心跳机制 + 投票裁决。

简单来说，哨兵的作用就是监控 Redis 系统的运行状况。它的功能包括以下两个：

1. 监控主数据库和从数据库是否正常运行；
1. 主数据库出现故障时自动将从数据库转换为主数据库；

哨兵模式主要有下面几个内容：

- 监控（ Monitoring）：Sentinel 会定期检查主从服务器是否处于正常工作状态。
- 提醒（ Notification ）：当被监控的某个 Redis 服务器出现异常时，Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。
- 自动故障迁移（Automatic failover）：当一个主服务器不能正常工作时，Sentinel 会开始一次自动故障迁移操作，它会将失效主服务器的其中一个从服务器升级为新的主服务器，并让失效主服务器的其他从服务器改为复制新的主服务器；当客户端试图连接失效的主服务器时，集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。

Redis Sentinel 是一个分布式系统，你可以在一个架构中运行多个 Sentinel 进程（ progress ）。

如图：

![NWBdun.png](https://s1.ax1x.com/2020/06/29/NWBdun.png)

**优点：**

1. 哨兵模式主从可以切换，具备基本的故障转移能力；
1. 哨兵模式具备主从模式的所有优点；

**缺点：**

1. 哨兵模式也很难支持在线扩容操作；
1. 集群的配置信息管理比较复杂；

## 1.3 Cluster 集群模式

Redis Cluster 是一种服务器 Sharding 技术，3.0 版本开始正式提供。采用无中心结构，每个节点保存数据和整个集群状态,每个节点都和其他所有节点连接。如图所示：
![NWBggJ.png](https://s1.ax1x.com/2020/06/29/NWBggJ.png)

Cluster 集群结构特点：

1. Redis Cluster 所有的物理节点都映射到 [ 0-16383 ] slot 上（不一定均匀分布），Cluster 负责维护节点、桶、值之间的关系；
1. 在 Redis 集群中放置一个 key-value 时，根据 CRC16(key) mod 16384 的值，从之前划分的 16384 个桶中选择一个；
1. 所有的 Redis 节点彼此互联（PING-PONG 机制），内部使用二进制协议优化传输效率；
1. 超过半数的节点检测到某个节点失效时则判定该节点失效；
1. 使用端与 Redis 节点链接,不需要中间 proxy 层，直接可以操作，使用端不需要连接集群所有节点，连接集群中任何一个可用节点即可。

**优点**

1. 无中心架构，节点间数据共享，可动态调整数据分布；
1. 节点可动态添加删除，扩展性比较灵活；
1. 部分节点异常，不影响整体集群的可用性。

**缺点**

1. 集群实现比较复杂；
1. 批量操作指令（ mget、mset 等）支持有限；
1. 事务操作支持有限。
